<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="dude-layout-tabs.html">
<link rel="import" href="dude-layout-pages.html">

<!--
`dude-layout-block`
@group dude-layout
@element dude-layout-block
-->
<dom-module id="dude-layout-block">

    <style>
        :host {
            position: relative;
            box-sizing: border-box;
            display: flex;
            flex: 1;
            flex-wrap: nowrap;
            align-items: stretch;
            flex-direction: column;

            min-width: var(--dude-layout-panel-min-width);
            min-height: var(--dude-layout-panel-min-height);

            @apply(--magnet-grid-block);
        }
    </style>

    <template>
        <dude-layout-tabs id="tabs" selected="{{_selected}}"></dude-layout-tabs>
        <dude-layout-pages id="pages" selected="{{_selected}}"></dude-layout-pages>
    </template>

    <script>
        DudeLayoutBlock = Polymer({
            is: "dude-layout-block",

            properties: {

                /**
                 * Config of this block and it children.
                 *
                 * @type {Object}
                 */
                config: {
                    type: Object
                },

                /**
                 * Option to enable the auto-save the current config object.
                 *
                 * @type {Boolean}
                 */
                autoSave: {
                    type: Boolean,
                    value: false
                },

                /**
                 * Contains all children elements of the block.
                 *
                 * @private
                 * @type {Array<{DudeLayoutTab, Object}>}
                 */
                _children: {
                    type: Array,
                    value: []
                },

                /**
                 * Defines the current page and tab selection by the ID.
                 *
                 * @private
                 * @type {String}
                 */
                _selected: {
                    type: String,
                    notify: true
                }
            },

            /**
             * DudeLayoutBlock constructor.
             * It will load automatically load the config given.
             *
             * @constructor
             * @param config {Object}
             */
            factoryImpl: function (config) {
                this.config = config;
                this.load();
            },

            /**
             * Load the block from the config.
             */
            load: function () {
                if (this.config.type === "block") {
                    this.config.children.forEach(function (child) {
                        if (child.type === "page") {
                            var page = new window[child.page];
                            this.insertElementBefore(page, child.title, undefined);
                            if (!this._selected || (child.selected !== undefined && child.selected === true)) {
                                this._getTabs().select(page.id);
                            }
                        }
                    }.bind(this));
                }
            },

            /**
             * Insert the page object from the config in the dock.
             * A tab will be created with the given title.
             *
             * @param page      {Object}
             * @param title     {String}
             * @param before    {DudeLayoutTab, Object, string}
             */
            insertElementBefore: function (page, title, before) {
                var tab = new DudeLayoutTab(title);
                var id = Math.random().toString(36).substr(2, 9);
                tab.id = id;
                page.id = id;
                this._children.push({
                    "panel": page,
                    "tab": tab,
                    "id": id
                });
                this._getTabs().insertBefore(tab, (before !== undefined) ? before.tab : undefined);
                this._getPages().insertBefore(page, (before !== undefined) ? before.panel : undefined);
            },

            _getTabs: function () {
                return this.$.tabs;
            },

            _getPages: function () {
                return this.$.pages;
            },

            // TODO redo les fonctions en dessous

            removePanel: function (panel) {
                var p = Polymer.dom(this._getPanels).querySelector(panel.is);
                if (p === undefined) {
                    return;
                }
                Polymer.dom(this._getPanels).removeChild(p);
                panel._block = null;
                Polymer.dom(this._getTabs).childNodes.every(function (child) {
                    if (child.id === panel.name) {
                        this.removeChild(child);
                        return false;
                    }
                    return true;
                });
                Polymer.dom.flush();
            },

            isResizable: function (value, from) {
                if (((from === "top" || from === "bottom") && this.getHeight() + value < 200) || ((from === "right" || from === "left") && this.getWidth() + value < 200)) {
                    return false;
                }
                this.checked = true;
                return true;
            },

            resize: function (value, from) {
                if (!this.checked) {
                    return;
                }
                this.checked = false;
                this.setWidth(this.getWidth());
                this.setHeight(this.getHeight());
                this.style["flex"] = "none";
                if (from === "right" || from === "left") {
                    this.setWidth(this.getWidth() + value);
                } else if (from === "top" || from === "bottom") {
                    this.setHeight(this.getHeight() + value);
                }
            },

            getWidth: function () {
                return parseFloat(getComputedStyle(this)["width"]);
            },

            getHeight: function () {
                return parseFloat(getComputedStyle(this)["height"]);
            },

            setWidth: function (width) {
                this.style["width"] = width + "px";
            },

            setHeight: function (height) {
                this.style["height"] = height + "px";
            }
        });
    </script>

</dom-module>