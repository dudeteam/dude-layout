<!--
Copyright (c) 2015 DudeTeam. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="dude-layout-separator.html">
<link rel="import" href="dude-layout-block.html">

<!--
`dude-layout-dock`
@group dude-layout
@element dude-layout-dock
-->
<dom-module id="dude-layout-dock">

    <style>
        :host {
            display: flex;
            flex: 1;
            flex-wrap: nowrap;
            align-content: stretch;
            align-items: stretch;
            flex-direction: column;
            height: 100%;

            @apply(--magnet-grid-container);
        }

        :host([horizontal]) {
            flex-direction: row;
        }
    </style>

    <template>
        <content></content>
    </template>

    <script>
        DudeLayoutDock = Polymer({
            is: "dude-layout-dock",

            properties: {

                /**
                 * Config of this dock and it children.
                 *
                 * @type {Object}
                 */
                config: {
                    type: Object,
                    notify: true
                },

                /**
                 * Option to enable the auto-save the current config object.
                 *
                 * @type {Boolean}
                 */
                autoSave: {
                    type: Boolean,
                    value: false
                },

                /**
                 * Defines the direction of sub elements in the dock.
                 * If false, the direction is vertical.
                 *
                 * @type {Boolean}
                 */
                horizontal: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },

                /**
                 * Contains all children elements of the dock.
                 *
                 * @private
                 * @type {Array<DudeLayoutDock|DudeLayoutBlock>}
                 */
                _children: {
                    type: Array,
                    value: []
                }
            },

            /**
             * DudeLayoutDock constructor.
             * It will load automatically load the config given.
             *
             * @constructor
             * @param config {Object}
             */
            factoryImpl: function (config) {
                this.config = config;
                this.load();
            },

            /**
             * Load the dock from the config.
             */
            load: function () {
                if (this.config.type === "dock" || this.config.type === "main") {
                    if (this.config.horizontal !== undefined) {this.horizontal = this.config.horizontal;}
                    this.config.children.forEach(function (child) {
                        var element = null;
                        switch (child.type) {
                            case "dock":
                                element = new DudeLayoutDock(child);
                                break;
                            case "block":
                                element = new DudeLayoutBlock(child);
                                break;
                            default:
                                break;
                        }
                        if (element != null) {
                            element.autoSave = this.autoSave;
                            this.insertElementBefore(element, null);
                        }
                    }.bind(this));
                }
            },

            /**
             * Insert a new element in the dock.
             * If 'before' element is set, it will insert the new element before it.
             */
            insertElementBefore: function (element, before) {
                if (before) {
                    if (!Polymer.dom(this).childNodes.contains(before)) {
                        console.log("bite");
                        return;
                    }
                    var sep = new DudeLayoutSeparator();
                    sep.horizontal = this.horizontal;
                    Polymer.dom(this).insertBefore(sep, before);
                    Polymer.dom(this).insertBefore(element, sep);
                    this._children.splice(this.children.indexOf(before), 0, element);
                } else {
                    if (Polymer.dom(this).childNodes.length != 0) {
                        var separator = new DudeLayoutSeparator();
                        separator.horizontal = this.horizontal;
                        Polymer.dom(this).appendChild(separator);
                    }
                    Polymer.dom(this).appendChild(element);
                    this._children.push(element);
                }
                Polymer.dom.flush();
            },

            /**
             * Execute the saving of the current configuration in the config.
             */
            save: function () {
                this.config.children = [];
                this._children.forEach(function (child) {
                    child.save();
                    this.config.children.push(child);
                }.bind(this))
            },

            /**
             * Destroy the current dock and children.
             * But the config will not be affected.
             */
            destroy: function () {
                Polymer.dom(this).childNodes.forEach(function (child) {
                    if (this.children.contains(child)) {
                        child.destroy();
                    }
                    Polymer.dom(this).removeChild(child);
                }.bind(this))
            },

            // TODO redo les fonctions en dessous

            /**
             * Returns whether the dock is resizable.
             * @param value {Number} The resize delta in pixel
             * @param origin {String} The direction from which the resize comes from
             * @returns {Boolean}
             */
            isResizable: function (value, origin) {
                if (Polymer.dom(this).childNodes.length == 0) { return true; }
                if (!this.horizontal) {
                    if (origin === "top") {
                        return Polymer.dom(this).firstElementChild.isResizable(value, origin);
                    } else if (origin === "bottom") {
                        return Polymer.dom(this).lastElementChild.isResizable(value, origin);
                    }
                } else {
                    if (origin === "right") {
                        return Polymer.dom(this).firstElementChild.isResizable(value, origin);
                    } else if (origin === "left") {
                        return Polymer.dom(this).lastElementChild.isResizable(value, origin);
                    }
                }
                for (var i = 0; i < Polymer.dom(this).childNodes.length; i++) {
                    var child = Polymer.dom(this).childNodes[i];
                    if (!(child instanceof DudeLayoutSeparator)) {
                        if (!child.isResizable(value, origin)) {
                            return false;
                        }
                    }
                }
                return true;
            },

            /**
             * Performs the resize of the dock.
             * @param value {Number} The resize delta in pixel
             * @param origin {String} The direction from which the resize comes from
             * @returns {*}
             */
            resize: function (value, origin) {
                if (Polymer.dom(this).childNodes.length == 0 || isNaN(value)) {
                    return;
                }
                if (!this.horizontal) {
                    if (origin === "top") {
                        Polymer.dom(this).firstElementChild.resize(value, origin);
                    } else if (origin === "bottom") {
                        Polymer.dom(this).lastElementChild.resize(value, origin);
                    }
                } else {
                    if (origin === "right") {
                        Polymer.dom(this).firstElementChild.resize(value, origin);
                    } else if (origin === "left") {
                        Polymer.dom(this).lastElementChild.resize(value, origin);
                    }
                }
                Polymer.dom(this).childNodes.forEach(function(child) {
                    if (!(child instanceof DudeLayoutSeparator)) {
                        child.resize(value, origin);
                    }
                });
            }
        });
    </script>

</dom-module>